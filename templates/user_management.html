{% extends 'base.html' %}
{% load static %}

{% block title %}User List | Paperless System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">User List</h2>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-primary border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">GOVERNORS</small>
                        <h3 class="fw-bold mb-0">{{ governor_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-success border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">OFFICE HEADS</small>
                        <h3 class="fw-bold mb-0">{{ heads_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-warning border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">EXECUTIVES</small>
                        <h3 class="fw-bold mb-0">{{ executive_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-info border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">TOTAL STAFF</small>
                        <h3 class="fw-bold mb-0">{{ staff_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <div class="card-title">Registered User Profiles</div>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-striped my-4 w-100" id="userTable">
                <thead>
                    <tr>
                        <th data-priority="1">User</th>
                        <th data-priority="3">Office</th>
                        <th data-priority="2">Role</th>
                        <th data-priority="4">Status</th>
                        <th data-priority="5">Last Login</th>
                        <th data-priority="6">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for userprofile in userprofiles %}
                    <tr>
                        <td>
                            <div class="fw-bold">{{ userprofile.user.get_full_name|default:userprofile.user.username }}</div>
                            <small class="text-muted">{{ userprofile.user.email|default:"No email" }}</small>
                        </td>
                        <td>
                            {% if userprofile.office %}
                                {{ userprofile.office.office_name }}
                            {% else %}
                                <span class="text-muted">Not Assigned</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-secondary">
                                {{ userprofile.get_role_display }}
                            </span>
                        </td>
                        <td>
                            {% if userprofile.user.is_active %}
                                <span class="badge badge-success">Active</span>
                            {% else %}
                                <span class="badge badge-danger">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if userprofile.user.last_login %}
                                {{ userprofile.user.last_login|date:"M d, Y H:i" }}
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary edit-user" 
                                        data-user-id="{{ userprofile.id }}" 
                                        title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-user" 
                                        data-user-id="{{ userprofile.id }}" 
                                        title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <!-- Empty - DataTable will show "No data available" -->
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">  
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="fas fa-user-plus me-2 text-primary"></i>
                    Register New User
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'register_user' %}" id="addUserForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="username" class="fw-bold">Username <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="email" class="fw-bold">Email Address</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    </div>
                                    <input type="email" class="form-control" id="email" name="email" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="first_name" class="fw-bold">First Name</label>
                                <input type="text" class="form-control" id="first_name" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="last_name" class="fw-bold">Last Name</label>
                                <input type="text" class="form-control" id="last_name" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="password" class="fw-bold">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    </div>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text" onclick="togglePassword()" style="cursor: pointer;">
                                            <i class="fas fa-eye" id="toggleIcon"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="confirm_password" class="fw-bold">Confirm Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="office" class="fw-bold">Office</label>
                                <select name="office" class="form-select select2" id="office-select" style="width: 100%;">
                                    <option value="">Select Office (Optional)</option>
                                    {% for office in offices %}
                                    <option value="{{ office.id }}">{{ office.office_name }} ({{ office.office_code }})</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Leave empty if not assigned to an office</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="role" class="fw-bold">Role <span class="text-danger">*</span></label>
                                <select class="form-control" id="role" name="role" required>
                                    <option value="STAFF">Staff</option>
                                    <option value="HEAD">Office Head</option>
                                    <option value="EXECUTIVE">Executive</option>
                                    <option value="GOVERNOR">Governor</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="is_active" name="is_active" checked>
                            <label class="custom-control-label" for="is_active">Active Account</label>
                        </div>
                        <small class="text-muted">If unchecked, user won't be able to log in</small>
                    </div>
                    
                    <div class="alert alert-info mt-3" id="passwordStrength" style="display: none;">
                        <strong>Password Strength:</strong> <span id="strengthText">Weak</span>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-2"></i>Create Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editUserModalLabel">
                    <i class="fas fa-user-edit me-2"></i>
                    Edit User
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="editUserModalContent">
                <!-- Content will be loaded dynamically via AJAX -->
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Loading user data...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                <p class="text-danger mb-0"><strong>Note:</strong> All documents and routings created by this user will also be deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
.modal-lg {
    max-width: 800px;
}
.border-start {
    border-left-width: 5px !important;
    border-left-style: solid !important;
}
</style>
{% endblock %}

{% block extra_js %}
{% if messages %}
    <div id="django-messages" style="display: none;" 
         data-messages='[
            {% for message in messages %}
                {"tag": "{{ message.tags }}", "text": "{{ message|escapejs }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
         ]'>
    </div>
{% endif %}
<script>
let deleteUserId = null;

$(document).ready(function() {
    // Initialize Select2 for the add user modal (matching registration page style)
    if ($.fn.select2) {
        $('#office-select').select2({
            width: '100%',
            placeholder: "Select Office (Optional)",
            allowClear: true,
            dropdownParent: $('#addUserModal')
        });
    } else {
        console.error('Select2 not loaded');
    }
    
    // Modal fix for all modals
    $('#addUserModal, #editUserModal, #deleteModal, #userDetailsModal').appendTo('body');
    
    $('[id$=Modal]').on('show.bs.modal', function() {
        $('body').addClass('modal-open');
        $('.wrapper, .content-wrapper, .main-content, .container-fluid').css('z-index', 'auto');
    });
    
    $('[id$=Modal]').on('hidden.bs.modal', function() {
        $('body').removeClass('modal-open');
        $('.modal-backdrop').remove();
        
        // Destroy Select2 instance when modal is hidden to prevent issues
        if ($.fn.select2 && $('#office-select').data('select2')) {
            $('#office-select').select2('destroy');
        }
    });
    
    // Re-initialize Select2 when modal is shown
    $('#addUserModal').on('shown.bs.modal', function() {
        setTimeout(function() {
            if ($.fn.select2 && !$('#office-select').data('select2')) {
                $('#office-select').select2({
                    width: '100%',
                    placeholder: "Select Office (Optional)",
                    allowClear: true,
                    dropdownParent: $('#addUserModal')
                });
            }
        }, 100);
    });

    // Handle Django messages
    var messagesData = $('#django-messages').data('messages');
    if (messagesData && messagesData.length > 0) {
        messagesData.forEach(function(message) {
            if (message.tag === 'success') {
                showSuccess(message.text);
            } else if (message.tag === 'error') {
                showError(message.text);
            } else {
                showError(message.text);
            }
        });
    }

    // Always initialize DataTable - even with no rows
    setTimeout(function() {
        if ($('#userTable').length) {
            // Destroy existing instance if any
            if ($.fn.DataTable.isDataTable('#userTable')) {
                $('#userTable').DataTable().destroy();
            }
            
            $('#userTable').DataTable({
                dom: "<'row'<'col-sm-12 col-md-6'f><'col-sm-12 col-md-6'B>>" +
                     "<'row'<'col-sm-12'tr>>" +
                     "<'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
                responsive: true,
                autoWidth: false,
                order: [[0, 'asc']],
                buttons: [
                    {
                        text: '<i class="fas fa-user-plus me-2"></i> Register New User',
                        className: 'btn btn-primary',
                        action: function (e, dt, node, config) {
                            $('#addUserModal').modal('show');
                        }
                    }
                ],
                columnDefs: [
                    { orderable: false, targets: 5 }
                ],
                language: {
                    search: "Search:",
                    searchPlaceholder: "Search all columns...",
                    lengthMenu: "Show _MENU_ entries",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    infoEmpty: "Showing 0 to 0 of 0 entries",
                    infoFiltered: "(filtered from _MAX_ total entries)",
                    emptyTable: "No users registered yet. Click 'Register New User' to add one.",
                    zeroRecords: "No matching users found",
                    paginate: {
                        first: '<i class="fa fa-angle-double-left"></i>',
                        previous: '<i class="fa fa-caret-left"></i>',
                        next: '<i class="fa fa-caret-right"></i>',
                        last: '<i class="fa fa-angle-double-right"></i>'
                    }
                },
                initComplete: function(settings, json) {
                    // Style DataTable controls
                    $('.dataTables_filter input').addClass('form-control form-control-sm').attr('placeholder', 'Search...');
                    $('.dataTables_length select').addClass('custom-select custom-select-sm form-control form-control-sm');
                }
            });
        }
    }, 100);
    
    // Edit user click handler
    $('.edit-user').on('click', function() {
        var userId = $(this).data('user-id');
        
        // Show the modal with loading spinner
        $('#editUserModal').modal('show');
        
        // Load the edit form via AJAX
        $.ajax({
            url: '/edit-user/' + userId + '/',
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#editUserModalContent').html(data);
                
                // Initialize Select2 for the edit form if it has an office select
                setTimeout(function() {
                    if ($.fn.select2 && $('#edit_office_select').length) {
                        $('#edit_office_select').select2({
                            width: '100%',
                            placeholder: "Select Office (Optional)",
                            allowClear: true,
                            dropdownParent: $('#editUserModal')
                        });
                    }
                }, 100);
                
                // Re-initialize password toggle and validation for the loaded form
                setupEditFormValidation();
            },
            error: function() {
                $('#editUserModalContent').html(
                    '<div class="modal-body">' +
                        '<div class="alert alert-danger">' +
                            'Error loading user data. Please try again.' +
                        '</div>' +
                    '</div>' +
                    '<div class="modal-footer bg-light">' +
                        '<button type="button" class="btn btn-secondary" data-dismiss="modal">' +
                            '<i class="fas fa-times me-2"></i>Close' +
                        '</button>' +
                    '</div>'
                );
            }
        });
    });
    
    // Delete user click handler - using SweetAlert directly
    $('.delete-user').on('click', function() {
        var userId = $(this).data('user-id');
        deleteUserId = userId;
        
        swal({
            title: "Are you sure?",
            text: "This user will be permanently deleted!",
            icon: "warning",
            buttons: {
                cancel: {
                    text: "Cancel",
                    value: null,
                    visible: true,
                    className: "",
                    closeModal: true,
                },
                confirm: {
                    text: "Yes, delete it!",
                    value: true,
                    visible: true,
                    className: "bg-danger",
                    closeModal: false
                }
            },
            dangerMode: true,
        })
        .then((willDelete) => {
            if (willDelete) {
                // Perform delete
                $.ajax({
                    url: '/delete-user/' + deleteUserId + '/',
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    success: function(response) {
                        swal({
                            title: "Deleted!",
                            text: response.message || "User deleted successfully!",
                            icon: "success",
                            buttons: {
                                confirm: {
                                    text: "OK",
                                    value: true,
                                    visible: true,
                                    className: "",
                                    closeModal: true
                                }
                            }
                        }).then(function() {
                            location.reload();
                        });
                    },
                    error: function(xhr) {
                        swal({
                            title: "Error!",
                            text: xhr.responseJSON?.error || "Error deleting user. Please try again.",
                            icon: "error",
                            buttons: {
                                confirm: {
                                    text: "OK",
                                    value: true,
                                    visible: true,
                                    className: "",
                                    closeModal: true
                                }
                            }
                        });
                    }
                });
            }
        });
    });
    
    // Password strength checker
    $("#password").on("keyup", function() {
        var password = $(this).val();
        checkPasswordStrength(password);
    });

    // Password confirmation
    $("#confirm_password").on("keyup", function() {
        var password = $("#password").val();
        var confirm = $(this).val();
        
        if (password !== confirm) {
            $(this).addClass("is-invalid");
        } else {
            $(this).removeClass("is-invalid");
        }
    });
    
    // Form validation
    $("#addUserForm").submit(function(e) {
        var password = $("#password").val();
        var confirm = $("#confirm_password").val();
        
        if (password !== confirm) {
            e.preventDefault();
            showError('Passwords do not match!');
            return false;
        }
        
        if (password.length < 8) {
            e.preventDefault();
            showError('Password must be at least 8 characters long!');
            return false;
        }
    });
});

function togglePassword() {
    var passwordField = $("#password");
    var toggleIcon = $("#toggleIcon");
    
    if (passwordField.attr("type") === "password") {
        passwordField.attr("type", "text");
        toggleIcon.removeClass("fa-eye").addClass("fa-eye-slash");
    } else {
        passwordField.attr("type", "password");
        toggleIcon.removeClass("fa-eye-slash").addClass("fa-eye");
    }
}

function checkPasswordStrength(password) {
    var strength = 0;
    var strengthText = "";
    var strengthColor = "";
    var strengthWidth = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.match(/[a-z]+/)) strength += 1;
    if (password.match(/[A-Z]+/)) strength += 1;
    if (password.match(/[0-9]+/)) strength += 1;
    if (password.match(/[$@#&!]+/)) strength += 1;
    
    $("#passwordStrength").show();
    
    switch(strength) {
        case 0:
        case 1:
            strengthText = "Very Weak";
            strengthColor = "danger";
            strengthWidth = "20%";
            break;
        case 2:
            strengthText = "Weak";
            strengthColor = "warning";
            strengthWidth = "40%";
            break;
        case 3:
            strengthText = "Medium";
            strengthColor = "info";
            strengthWidth = "60%";
            break;
        case 4:
            strengthText = "Strong";
            strengthColor = "primary";
            strengthWidth = "80%";
            break;
        case 5:
            strengthText = "Very Strong";
            strengthColor = "success";
            strengthWidth = "100%";
            break;
    }
    
    $("#strengthText").text(strengthText);
    $("#strengthBar").removeClass().addClass("progress-bar bg-" + strengthColor).css("width", strengthWidth);
}

function setupEditFormValidation() {
    // Password toggle for edit modal
    $('#editUserModal').off('click', '#editToggleIcon').on('click', '#editToggleIcon', function() {
        toggleEditPassword();
    });
    
    // Password strength checker
    $('#editUserModal').off('keyup', '#new_password').on('keyup', '#new_password', function() {
        var password = $(this).val();
        checkEditPasswordStrength(password);
    });
    
    // Password confirmation
    $('#editUserModal').off('keyup', '#confirm_password').on('keyup', '#confirm_password', function() {
        var password = $("#new_password").val();
        var confirm = $(this).val();
        
        if (password !== confirm) {
            $(this).addClass("is-invalid");
        } else {
            $(this).removeClass("is-invalid");
        }
    });
    
    // Handle form submission via AJAX
    $('#editUserModal').off('submit', '#editUserForm').on('submit', '#editUserForm', function(e) {
        e.preventDefault();
        
        var form = $(this);
        var password = $("#new_password").val();
        var confirm = $("#confirm_password").val();
        
        // Validate if password is being changed
        if (password || confirm) {
            if (password !== confirm) {
                showError('Passwords do not match!');
                return false;
            }
            
            if (password.length < 8) {
                showError('Password must be at least 8 characters long!');
                return false;
            }
        }
        
        // Show loading state
        $('#editSubmitBtn').html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...').prop('disabled', true);
        
        // Submit via AJAX
        $.ajax({
            url: form.attr('action'),
            method: 'POST',
            data: form.serialize(),
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                $('#editUserModal').modal('hide');
                showSuccess(response.message || 'User updated successfully!');
                setTimeout(function() {
                    location.reload();
                }, 2000);
            },
            error: function(xhr) {
                $('#editSubmitBtn').html('<i class="fas fa-save me-2"></i>Save Changes').prop('disabled', false);
                
                var errorMessage = 'Error updating user. Please try again.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMessage = xhr.responseJSON.error;
                }
                showError(errorMessage);
            }
        });
    });
}

function toggleEditPassword() {
    var passwordField = $("#new_password");
    var toggleIcon = $("#editToggleIcon");
    
    if (passwordField.attr("type") === "password") {
        passwordField.attr("type", "text");
        toggleIcon.removeClass("fa-eye").addClass("fa-eye-slash");
    } else {
        passwordField.attr("type", "password");
        toggleIcon.removeClass("fa-eye-slash").addClass("fa-eye");
    }
}

function checkEditPasswordStrength(password) {
    var strength = 0;
    var strengthText = "";
    var strengthColor = "";
    var strengthWidth = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.match(/[a-z]+/)) strength += 1;
    if (password.match(/[A-Z]+/)) strength += 1;
    if (password.match(/[0-9]+/)) strength += 1;
    if (password.match(/[$@#&!]+/)) strength += 1;
    
    if (password.length > 0) {
        $("#editPasswordStrength").show();
    } else {
        $("#editPasswordStrength").hide();
    }
    
    switch(strength) {
        case 0:
        case 1:
            strengthText = "Very Weak";
            strengthColor = "danger";
            strengthWidth = "20%";
            break;
        case 2:
            strengthText = "Weak";
            strengthColor = "warning";
            strengthWidth = "40%";
            break;
        case 3:
            strengthText = "Medium";
            strengthColor = "info";
            strengthWidth = "60%";
            break;
        case 4:
            strengthText = "Strong";
            strengthColor = "primary";
            strengthWidth = "80%";
            break;
        case 5:
            strengthText = "Very Strong";
            strengthColor = "success";
            strengthWidth = "100%";
            break;
    }
    
    $("#editStrengthText").text(strengthText);
    $("#editStrengthBar").removeClass().addClass("progress-bar bg-" + strengthColor).css("width", strengthWidth);
}

function viewUser(userId) {
    $("#userDetailsModal").modal('show');
    $("#userDetailsContent").html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading...</p></div>');
    
    $.ajax({
        url: '/user-details/' + userId + '/',
        method: 'GET',
        success: function(data) {
            $("#userDetailsContent").html(data);
        },
        error: function() {
            $("#userDetailsContent").html('<div class="alert alert-danger">Error loading user details.</div>');
            showError('Error loading user details.');
        }
    });
}

// Updated SweetAlert functions with correct v2 syntax
function showSuccess(message) {
    swal({
        title: "Success!",
        text: message,
        icon: "success",
        buttons: {
            confirm: {
                text: "OK",
                value: true,
                visible: true,
                className: "",
                closeModal: true
            }
        }
    });
}

function showError(message) {
    swal({
        title: "Error!",
        text: message,
        icon: "error",
        buttons: {
            confirm: {
                text: "OK",
                value: true,
                visible: true,
                className: "",
                closeModal: true
            }
        }
    });
}

function showWarning(message) {
    swal({
        title: "Warning!",
        text: message,
        icon: "warning",
        buttons: {
            confirm: {
                text: "OK",
                value: true,
                visible: true,
                className: "",
                closeModal: true
            }
        }
    });
}

function showInfo(message) {
    swal({
        title: "Info",
        text: message,
        icon: "info",
        buttons: {
            confirm: {
                text: "OK",
                value: true,
                visible: true,
                className: "",
                closeModal: true
            }
        }
    });
}
</script>
{% endblock %}