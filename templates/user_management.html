{% extends 'base.html' %}
{% load static %}

{% block title %}User Management | Paperless System{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-dark mb-1">User Management</h2>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-primary border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">GOVERNORS</small>
                        <h3 class="fw-bold mb-0">{{ governor_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-success border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">OFFICE HEADS</small>
                        <h3 class="fw-bold mb-0">{{ heads_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-warning border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">EXECUTIVES</small>
                        <h3 class="fw-bold mb-0">{{ executive_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm p-3 border-start border-info border-5">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted fw-bold">TOTAL STAFF</small>
                        <h3 class="fw-bold mb-0">{{ staff_count }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Button -->
    <div class="mb-4">
        <button class="btn btn-primary" data-toggle="modal" data-target="#addUserModal">
            <i class="fas fa-user-plus me-2"></i> Register New User
        </button>
    </div>

    <!-- Users Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold">Registered User Profiles</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped" id="userTable">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Office</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for userprofile in userprofiles %}
                        <tr>
                            <td>
                                <div class="fw-bold">{{ userprofile.user.get_full_name|default:userprofile.user.username }}</div>
                                <small class="text-muted">{{ userprofile.user.email|default:"No email" }}</small>
                            </td>
                            <td>
                                {% if userprofile.office %}
                                    {{ userprofile.office.office_name }}
                                    <small class="d-block text-muted">{{ userprofile.office.office_code }}</small>
                                {% else %}
                                    <span class="text-muted">Not Assigned</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge 
                                    {% if userprofile.role == 'GOVERNOR' %}badge-primary
                                    {% elif userprofile.role == 'HEAD' %}badge-success
                                    {% elif userprofile.role == 'EXECUTIVE' %}badge-warning
                                    {% else %}badge-secondary{% endif %}">
                                    {{ userprofile.get_role_display }}
                                </span>
                            </td>
                            <td>
                                {% if userprofile.user.is_active %}
                                    <span class="badge badge-success">Active</span>
                                {% else %}
                                    <span class="badge badge-danger">Inactive</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if userprofile.user.last_login %}
                                    {{ userprofile.user.last_login|date:"M d, Y H:i" }}
                                {% else %}
                                    <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editUser({{ userprofile.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser({{ userprofile.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-5">
                                <i class="fas fa-users fa-4x text-muted mb-3"></i>
                                <h5 class="mt-3 text-muted">No users registered yet</h5>
                                <p class="text-muted">Click the "Register New User" button to add your first user.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg" role="document">  
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="addUserModalLabel">
                    <i class="fas fa-user-plus me-2 text-primary"></i>
                    Register New User
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'register_user' %}" id="addUserForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="username" class="fw-bold">Username <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="username" name="username" required>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="email" class="fw-bold">Email Address</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    </div>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="first_name" class="fw-bold">First Name</label>
                                <input type="text" class="form-control" id="first_name" name="first_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="last_name" class="fw-bold">Last Name</label>
                                <input type="text" class="form-control" id="last_name" name="last_name">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="password" class="fw-bold">Password <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    </div>
                                    <input type="password" class="form-control" id="password" name="password" required>
                                    <div class="input-group-append">
                                        <span class="input-group-text" onclick="togglePassword()" style="cursor: pointer;">
                                            <i class="fas fa-eye" id="toggleIcon"></i>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="confirm_password" class="fw-bold">Confirm Password <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="office" class="fw-bold">Office</label>
                                <select class="form-control" id="office" name="office">
                                    <option value="">Select Office (Optional)</option>
                                    {% for office in offices %}
                                    <option value="{{ office.id }}">{{ office.office_name }} ({{ office.office_code }})</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Leave empty if not assigned to an office</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="role" class="fw-bold">Role <span class="text-danger">*</span></label>
                                <select class="form-control" id="role" name="role" required>
                                    <option value="STAFF">Staff</option>
                                    <option value="HEAD">Office Head</option>
                                    <option value="EXECUTIVE">Executive</option>
                                    <option value="GOVERNOR">Governor</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" id="is_active" name="is_active" checked>
                            <label class="custom-control-label" for="is_active">Active Account</label>
                        </div>
                        <small class="text-muted">If unchecked, user won't be able to log in</small>
                    </div>
                    
                    <div class="alert alert-info mt-3" id="passwordStrength" style="display: none;">
                        <strong>Password Strength:</strong> <span id="strengthText">Weak</span>
                        <div class="progress mt-2" style="height: 5px;">
                            <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save me-2"></i>Create Account
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                <p class="text-danger mb-0"><strong>Note:</strong> All documents and routings created by this user will also be deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- User Details Modal -->
<div class="modal fade" id="userDetailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">User Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="userDetailsContent">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="successToast" class="toast hide" role="alert">
        <div class="toast-header bg-success text-white">
            <strong class="mr-auto">Success</strong>
            <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
        </div>
        <div class="toast-body"></div>
    </div>
    <div id="errorToast" class="toast hide" role="alert">
        <div class="toast-header bg-danger text-white">
            <strong class="mr-auto">Error</strong>
            <button type="button" class="ml-2 mb-1 close text-white" data-dismiss="toast">&times;</button>
        </div>
        <div class="toast-body"></div>
    </div>
</div>

<style>
.modal-lg {
    max-width: 800px;
}
.border-start {
    border-left-width: 5px !important;
    border-left-style: solid !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let deleteUserId = null;

$(document).ready(function() {
    // Initialize DataTable with zero configuration
    $('#userTable').DataTable({
        dom: 'Bfrtip',
        buttons: [
            'copy', 'csv', 'excel', 'pdf', 'print'
        ],
        pageLength: 10,
        language: {
            search: "Search all columns:"
        }
    });
    
    // Password strength checker
    $("#password").on("keyup", function() {
        var password = $(this).val();
        checkPasswordStrength(password);
    });
    
    // Password confirmation
    $("#confirm_password").on("keyup", function() {
        var password = $("#password").val();
        var confirm = $(this).val();
        
        if (password !== confirm) {
            $(this).addClass("is-invalid");
        } else {
            $(this).removeClass("is-invalid");
        }
    });
    
    // Form validation
    $("#addUserForm").submit(function(e) {
        var password = $("#password").val();
        var confirm = $("#confirm_password").val();
        var username = $("#username").val();
        
        if (password !== confirm) {
            e.preventDefault();
            showToast('error', 'Passwords do not match!');
            return false;
        }
        
        if (password.length < 8) {
            e.preventDefault();
            showToast('error', 'Password must be at least 8 characters long!');
            return false;
        }
        
        if (username.length < 3) {
            e.preventDefault();
            showToast('error', 'Username must be at least 3 characters long!');
            return false;
        }
    });
});

function togglePassword() {
    var passwordField = $("#password");
    var toggleIcon = $("#toggleIcon");
    
    if (passwordField.attr("type") === "password") {
        passwordField.attr("type", "text");
        toggleIcon.removeClass("fa-eye").addClass("fa-eye-slash");
    } else {
        passwordField.attr("type", "password");
        toggleIcon.removeClass("fa-eye-slash").addClass("fa-eye");
    }
}

function checkPasswordStrength(password) {
    var strength = 0;
    var strengthText = "";
    var strengthColor = "";
    var strengthWidth = 0;
    
    if (password.length >= 8) strength += 1;
    if (password.match(/[a-z]+/)) strength += 1;
    if (password.match(/[A-Z]+/)) strength += 1;
    if (password.match(/[0-9]+/)) strength += 1;
    if (password.match(/[$@#&!]+/)) strength += 1;
    
    $("#passwordStrength").show();
    
    switch(strength) {
        case 0:
        case 1:
            strengthText = "Very Weak";
            strengthColor = "danger";
            strengthWidth = "20%";
            break;
        case 2:
            strengthText = "Weak";
            strengthColor = "warning";
            strengthWidth = "40%";
            break;
        case 3:
            strengthText = "Medium";
            strengthColor = "info";
            strengthWidth = "60%";
            break;
        case 4:
            strengthText = "Strong";
            strengthColor = "primary";
            strengthWidth = "80%";
            break;
        case 5:
            strengthText = "Very Strong";
            strengthColor = "success";
            strengthWidth = "100%";
            break;
    }
    
    $("#strengthText").text(strengthText);
    $("#strengthBar").removeClass().addClass("progress-bar bg-" + strengthColor).css("width", strengthWidth);
}

function deleteUser(userId) {
    deleteUserId = userId;
    $("#deleteModal").modal('show');
}

$("#confirmDelete").click(function() {
    if (deleteUserId) {
        // Show loading state
        $(this).html('<i class="fas fa-spinner fa-spin me-2"></i>Deleting...');
        $(this).prop('disabled', true);
        
        // Perform delete
        $.ajax({
            url: '/delete-user/' + deleteUserId + '/',
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                $("#deleteModal").modal('hide');
                showToast('success', 'User deleted successfully!');
                setTimeout(function() {
                    location.reload();
                }, 2000);
            },
            error: function(xhr) {
                showToast('error', xhr.responseJSON?.error || 'Error deleting user. Please try again.');
                $("#confirmDelete").html('Delete');
                $("#confirmDelete").prop('disabled', false);
            }
        });
    }
});

function editUser(userId) {
    window.location.href = '/edit-user/' + userId + '/';
}

function viewUser(userId) {
    $("#userDetailsModal").modal('show');
    $("#userDetailsContent").html('<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading...</p></div>');
    
    $.ajax({
        url: '/user-details/' + userId + '/',
        method: 'GET',
        success: function(data) {
            $("#userDetailsContent").html(data);
        },
        error: function() {
            $("#userDetailsContent").html('<div class="alert alert-danger">Error loading user details.</div>');
        }
    });
}

function showToast(type, message) {
    var toast = type === 'success' ? $('#successToast') : $('#errorToast');
    toast.find('.toast-body').text(message);
    toast.toast({ delay: 3000 });
    toast.toast('show');
}

// Handle messages from Django
{% if messages %}
    {% for message in messages %}
        $(document).ready(function() {
            {% if message.tags == 'success' %}
                showToast('success', '{{ message|escapejs }}');
            {% else %}
                showToast('error', '{{ message|escapejs }}');
            {% endif %}
        });
    {% endfor %}
{% endif %}
</script>
{% endblock %}